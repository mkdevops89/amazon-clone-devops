version: '3.8'

services:
  # ==========================================
  # Frontend Application (Next.js)
  # ==========================================
  frontend:
    # Build context points to the frontend directory containing Dockerfile
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: amazon-frontend
    ports:
      - "3000:3000" # Maps host port 3000 to container port 3000
    environment:
      # URL for the backend API (accessible via browser/client-side)
      - NEXT_PUBLIC_API_URL=http://localhost:8080/api
    depends_on:
      - backend # Ensures backend starts before frontend
    networks:
      - app-network

  # ==========================================
  # Backend Application (Spring Boot)
  # ==========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: amazon-backend
    ports:
      - "8080:8080" # Maps host port 8080 to container port 8080
    environment:
      # Database connection string pointing to 'mysql' service
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/amazonlike_db
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      # RabbitMQ host (service name)
      - SPRING_RABBITMQ_HOST=rabbitmq
      # Redis host (service name)
      - SPRING_DATA_REDIS_HOST=redis
    depends_on:
      # Wait for dependent services to be healthy before starting Spring Boot
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - app-network

  # ==========================================
  # Database (MySQL 8.0)
  # ==========================================
  mysql:
    image: mysql:8.0
    container_name: amazon-mysql
    ports:
      - "3306:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=amazonlike_db
    volumes:
      # Persist data to a local volume so it survives restart
      - mysql_data:/var/lib/mysql
      # Initialize DB with schema script
      - ./ops/docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      # Check if MySQL is ready to accept connections
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 20
    networks:
      - app-network

  # ==========================================
  # Message Broker (RabbitMQ)
  # ==========================================
  rabbitmq:
    image: rabbitmq:3-management # Includes Management UI
    container_name: amazon-rabbitmq
    ports:
      - "5672:5672"   # AMQP protocol port
      - "15672:15672" # Management UI port
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 20
    networks:
      - app-network

  # ==========================================
  # Caching Layer (Redis)
  # ==========================================
  redis:
    image: redis:alpine
    container_name: amazon-redis
    ports:
      - "6379:6379"
    networks:
      - app-network

  # ==========================================
  # Code Quality (SonarQube)
  # ==========================================
  sonarqube:
    image: sonarqube:community
    container_name: amazon-sonarqube
    ports:
      - "9000:9000"
    environment:
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs
    networks:
      - app-network

  # ==========================================
  # Observability (Datadog Agent)
  # ==========================================
  datadog:
    image: gcr.io/datadoghq/agent:7
    container_name: amazon-datadog
    environment:
      - DD_API_KEY=your_api_key_here # Replace with your real API Key
      - DD_SITE=datadoghq.com
      - DD_DOCKER_LABELS_AS_TAGS=true
    volumes:
      # Mount Docker socket to allow agent to collect metrics from containers
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
    networks:
      - app-network

networks:
  app-network:
    driver: bridge # Standard bridge network for container-to-container communication

volumes:
  mysql_data: # Named volume for MySQL persistence
  sonarqube_data:
  sonarqube_extensions:
  sonarqube_logs:
