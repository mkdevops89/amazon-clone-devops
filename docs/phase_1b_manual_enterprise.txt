# Phase 1b: The "Enterprise" Manual Provisioning (Multi-VM)

This guide follows the classic "VProfile" style of manual provisioning on separate VMs (CentOS/Ubuntu style).
This is **excellent practice** for understanding Linux Administration.

## ðŸ— Architecture
We will set up 5 Services on 5 different VMs (or VirtualBox Instances).
1.  **LB01 (Nginx)**: Load Balancer.
2.  **APP01 (Java 17)**: Application Server.
3.  **RMQ01 (RabbitMQ)**: Message Broker.
4.  **DB01 (MySQL)**: Database.
5.  **MC01 (Redis)**: Database Caching (Replacing Memcache).

## â“ Why Redis instead of Memcache?
We chose Redis for this project for two reasons:
1.  **Persistence**: Memcache loses everything if you restart the server. Redis can save data to disk (AOF/RDB).
2.  **Data Structures**: Memcache is just Strings. Redis supports Lists (for queues), HashMaps (for user sessions), and Sorted Sets (for leaderboards). It's more future-proof for an E-Commerce Cart.

---

## ðŸ›  1. DB01 (Database Setup)
*   **Hostname**: `db01`
*   **OS**: CentOS 8 / RHEL 8
*   **Tools**: `dnf` (Dandified YUM)

```bash
# 1. Install MariaDB (MySQL Fork)
sudo dnf update -y
sudo dnf install epel-release -y
sudo dnf install mariadb-server -y

# 2. Start Service
sudo systemctl start mariadb
sudo systemctl enable mariadb

# 3. Secure Installation
mysql_secure_installation
# Set root password to 'admin123'
# Disallow root login remotely? NO (We need to connect from APP01)
# Remove test database? YES

# 4. Create User & Access
mysql -u root -padmin123
> create database amazonlike_db;
> grant all privileges on amazonlike_db.* TO 'admin'@'%' identified by 'admin123';
> FLUSH PRIVILEGES;
> exit;

# 5. Firewall (Open Port 3306)
sudo systemctl start firewalld
sudo firewall-cmd --zone=public --add-port=3306/tcp --permanent
sudo firewall-cmd --reload
```

---

## ðŸ›  2. MC01 (Cache Setup - Redis)
*   **Hostname**: `mc01`
*   **OS**: CentOS 8

```bash
# 1. Install Redis
sudo dnf install redis -y
sudo systemctl start redis
sudo systemctl enable redis

# 2. Configure Listen Address
# By default, Redis only listens on localhost.
sudo sed -i 's/bind 127.0.0.1/bind 0.0.0.0/g' /etc/redis.conf

# 3. Restart & Firewall
sudo systemctl restart redis
sudo firewall-cmd --add-port=6379/tcp --permanent
sudo firewall-cmd --reload
```

---

## ðŸ›  3. RMQ01 (RabbitMQ Setup)
*   **Hostname**: `rmq01`
*   **OS**: CentOS 8

```bash
# 1. Install RabbitMQ (Requires Erlang)
sudo dnf install rabbitmq-server -y
sudo systemctl start rabbitmq-server
sudo systemctl enable rabbitmq-server

# 2. Enable Management UI & Create User
sudo rabbitmq-plugins enable rabbitmq_management
sudo rabbitmqctl add_user admin admin123
sudo rabbitmqctl set_user_tags admin administrator
sudo rabbitmqctl set_permissions -p / admin ".*" ".*" ".*"

# 3. Firewall (5672 for App, 15672 for UI)
sudo firewall-cmd --add-port=5672/tcp --permanent
sudo firewall-cmd --add-port=15672/tcp --permanent
sudo firewall-cmd --reload
```

---

## ðŸ›  4. APP01 (Backend Setup)
*   **Hostname**: `app01`
*   **Software**: Java 17, Maven

```bash
# 1. Install Java 17
sudo dnf install java-17-openjdk-devel -y

# 2. Install Maven
wget https://archive.apache.org/dist/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz
tar -xvf apache-maven-*.tar.gz
export PATH=$PATH:/tmp/apache-maven-3.9.6/bin

# 3. Clone & Build
git clone https://github.com/your-repo/amazon-clone.git
cd amazon-clone/backend
mvn install

# 4. Run (With Env Vars pointing to other VMs)
export SPRING_DATASOURCE_URL=jdbc:mysql://db01:3306/amazonlike_db
export SPRING_RABBITMQ_HOST=rmq01
export SPRING_DATA_REDIS_HOST=mc01
java -jar target/*.jar
```

---

## ðŸ›  5. WEB01 (Nginx Load Balancer)
*   **Hostname**: `web01`
*   **OS**: Ubuntu (Common for Web Tier)

```bash
# 1. Install Nginx
sudo apt update && sudo apt install nginx -y

# 2. Configure Reverse Proxy
# Edit /etc/nginx/sites-available/app
cat <<EOF > /etc/nginx/sites-available/app
upstream backend {
    server app01:8080;
}
server {
    listen 80;
    location /api {
        proxy_pass http://backend;
    }
}
EOF

# 3. Enable & Restart
sudo ln -s /etc/nginx/sites-available/app /etc/nginx/sites-enabled/
sudo systemctl restart nginx
```
