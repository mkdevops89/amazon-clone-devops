# Phase 8: Configuration Management (Ansible)

**Goal**: Configure 100 servers at once without SSH-ing into each one.
**Role**: SysAdmin / DevOps Engineer.

## üõ† Prerequisites
*   **Vagrant**: Installed (`brew install vagrant`).
*   **VirtualBox**: Installed.
*   **Ansible**: Installed (`brew install ansible`).

## üìù Concept
Terraform creates the VM (Infrastructure).
Ansible installs the software inside the VM (Configuration).

## üìù Step-by-Step Runbook

### 1. The Inventory
Ansible needs a "Phone Book" of servers to talk to.
Look at `ops/ansible/inventory.ini` (or the dynamic inventory generated by Vagrant).
For this demo, Vagrant handles it automatically.

### 2. The Playbook
Look at `ops/ansible/playbook.yml`.
```yaml
- hosts: all
  tasks:
    - name: Install Docker
      apt:
        name: docker.io
        state: present
```
It reads like English: "On all hosts, ensure Docker is present."

### 3. Provisioning (The "Push")
Instead of running commands manually, we tell Vagrant to run Ansible.
```bash
cd ops/vagrant
vagrant up --provision
```
*   **What happens**:
    1.  Vagrant boots the VM.
    2.  Vagrant generates an Ansible Inventory.
    3.  Vagrant runs `ansible-playbook`.
    4.  Ansible connects via SSH and installs Docker, Compose, and Git.

### 4. Manual Execution (Advanced)
If you weren't using Vagrant, you would run this:
```bash
# This is hypothetical for a real server IP 1.2.3.4
ansible-playbook -i "1.2.3.4," -u ubuntu --private-key ~/.ssh/id_rsa ops/ansible/playbook.yml
```

### 5. Validation
SSH into the VM and verify Ansible did its job.
```bash
vagrant ssh
docker --version
# Expected: Docker version 24.x.x
```

### 6. Idempotency (The Magic)
Run the provision command again.
```bash
vagrant provision
```
*   **Result**: Ansible says `ok=3 changed=0`.
*   **Why**: It checks first. "Docker is already installed? Okay, do nothing."
*   **Benefit**: You can run this 1000 times without breaking anything. Shell scripts would try to install it again and fail.

## üöÄ Troubleshooting
*   **"Unreachable"**: Ansible can't SSH. Check your SSH keys or IP address.
*   **"Permission denied"**: You need `become: yes` (sudo) in your playbook.

## üöÄ Next Level
Configuring servers at runtime ("Mutable") is slow.
Go to **[Phase 10: Immutable Infrastructure (Packer)](./phase_10.md)** to learn how to "Bake" these configurations into the image itself.
